<!DOCTYPE html>
<html>
<head>

    <meta charset="UTF-8">
    <title>Capital</title>
    
    <!-- Bootstrap
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script> -->
    
    <!-- Firebase Reference -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-firestore.js"></script>

    
    <!-- Moment.js Reference -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="224801706485-p4ma0qdd2igcqjd32ulvkh4q75fa7ves.apps.googleusercontent.com">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
</head>
      
<body>
<div id="control-panel"><span id="name">Nobody</span> <span id="score">100</span></div>
<div class="g-signin2" data-onsuccess="onSignIn"></div>
<a href="#" onclick="signOut();">Sign out</a>
<script>
  function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
      console.log('User signed out.');
    });
  }
</script>
<form id="chat-form">
            <label for="chat-input">Make a new post</label>
            <input type="text" id="chat-input"><br>
        
            <!-- Button triggers new chat to be added -->
            <input id="add-chat" type="submit" value="Post">
</form>
<div id="chat"></div>
<script>
$(document).ready(function() {
    var name;

    function onSignIn(googleUser) {
        console.log("Signed In!");
        var profile = googleUser.getBasicProfile();
        name = profile.getName();
        console.log("Welcome, " + name);

        db.collection("users").where("name", "==", name)
        .onSnapshot(function(querySnapshot) {
            console.log(querySnapshot);
            if (querySnapshot.docs.size === 0){
                db.collection("users").add({
                    name: name,
                    score: 100 
                })
                .then(function(docRef) {
                    console.log("User added with ID: ", docRef.id);
                })
                .catch(function(error) {
                    console.error("Error adding user: ", error);
                });
            }


        });
    }
    

    console.log("Tragedy");

    firebase.initializeApp({
        apiKey: 'AIzaSyCpx0dAKNSqol9123GLyuhaIqkzLvdIVrA',
        authDomain: 'https://capital-1556235479390.firebaseio.com/',
        projectId: 'capital-1556235479390'
    });

    // import("firebase/app");
    // import("firebase/firestore");
    
    var db = firebase.firestore();

    db.collection("posts").where("score", ">", -1)
    .onSnapshot(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
            var post = $("<div>");
            $("<h4>"+ doc.data().author + "</h4>").appendTo(post);
            $("<button data-author='"+ doc.data().author +"' data-id='" + doc.data().id + "'>" + doc.data().score + "</button>").appendTo(post);
            $("<p>" + doc.data().content + "</p>").appendTo(post);
            post.appendTo($("#chat"));
        });
    });


    
});
</script>
</body>
</html>